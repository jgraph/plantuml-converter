<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlantUML to draw.io Converter</title>
<style>
	* { margin: 0; padding: 0; box-sizing: border-box; }

	body {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		height: 100vh;
		display: flex;
		flex-direction: column;
		background: #f5f5f5;
	}

	header {
		padding: 10px 20px;
		background: #fff;
		border-bottom: 1px solid #ddd;
		display: flex;
		align-items: center;
		gap: 16px;
		flex-shrink: 0;
	}

	header h1 {
		font-size: 16px;
		font-weight: 600;
		color: #333;
	}

	#convert-btn {
		padding: 6px 20px;
		background: #4a86c8;
		color: #fff;
		border: none;
		border-radius: 4px;
		font-size: 13px;
		cursor: pointer;
	}

	#convert-btn:hover { background: #3a76b8; }

	#convert-btn:active { background: #2a66a8; }

	.shortcut-hint {
		font-size: 11px;
		color: #999;
	}

	#diagram-type {
		font-size: 12px;
		color: #666;
		margin-left: auto;
	}

	.main {
		flex: 1;
		display: flex;
		min-height: 0;
	}

	.pane {
		flex: 1;
		display: flex;
		flex-direction: column;
		min-width: 0;
	}

	.pane-header {
		padding: 6px 12px;
		background: #e8e8e8;
		font-size: 11px;
		font-weight: 600;
		color: #666;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		flex-shrink: 0;
	}

	.left-pane {
		border-right: 1px solid #ddd;
	}

	#editor {
		flex: 1;
		width: 100%;
		padding: 12px;
		border: none;
		outline: none;
		resize: none;
		font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
		font-size: 13px;
		line-height: 1.5;
		tab-size: 4;
		background: #fff;
	}

	#error {
		padding: 8px 12px;
		background: #fee;
		color: #c00;
		font-size: 12px;
		font-family: monospace;
		border-top: 1px solid #fcc;
		display: none;
		flex-shrink: 0;
	}

	#error.visible {
		display: block;
	}

	#viewer-container {
		flex: 1;
		overflow: auto;
		background: #fff;
		padding: 10px;
	}

	#viewer-container .geDiagramContainer {
		overflow: visible !important;
	}

	.loading {
		display: flex;
		align-items: center;
		justify-content: center;
		height: 100%;
		color: #999;
		font-size: 13px;
	}
</style>
</head>
<body>

<header>
	<h1>PlantUML to draw.io</h1>
	<button id="convert-btn">Convert</button>
	<span class="shortcut-hint">Ctrl+Enter</span>
	<span id="diagram-type"></span>
</header>

<div class="main">
	<div class="pane left-pane">
		<div class="pane-header">PlantUML</div>
		<textarea id="editor" spellcheck="false">@startuml
title E-Commerce Order Processing

actor Customer
participant "Web App" as Web
participant "Order Service" as Orders
participant "Payment Gateway" as Payment
database "Order DB" as DB
participant "Notification Service" as Notify

== Place Order ==

Customer -> Web : Add to cart
Customer -> Web : Checkout

Web -> Orders : createOrder(items, customer)
activate Orders

Orders -> DB : saveOrder(pending)
activate DB
DB --> Orders : orderId
deactivate DB

Orders -> Payment : processPayment(amount, card)
activate Payment

alt payment success
  Payment --> Orders : paymentConfirmed
  Orders -> DB : updateStatus(paid)
  Orders -> Notify : sendConfirmation(orderId)
  activate Notify
  Notify --> Customer : Order confirmation email
  deactivate Notify
  Orders --> Web : orderConfirmed(orderId)
else payment failed
  Payment --> Orders : paymentDeclined(reason)
  Orders -> DB : updateStatus(failed)
  Orders --> Web : orderFailed(reason)
  Web --> Customer : Payment error message
end

deactivate Payment
deactivate Orders

== Delivery ==

Customer -> Web : confirmDelivery(orderId)
Web -> Orders : markDelivered(orderId)
Orders -> DB : updateStatus(delivered)
@enduml</textarea>
		<div id="error"></div>
	</div>

	<div class="pane">
		<div class="pane-header">draw.io Output</div>
		<div id="viewer-container">
			<div class="loading">Loading viewer...</div>
		</div>
	</div>
</div>

<script type="module">
	import { convert } from './PlantUmlImporter.js';

	const editor = document.getElementById('editor');
	const errorDiv = document.getElementById('error');
	const viewerContainer = document.getElementById('viewer-container');
	const convertBtn = document.getElementById('convert-btn');
	const diagramTypeSpan = document.getElementById('diagram-type');

	let viewerReady = false;
	let pendingConvert = false;

	function showError(msg) {
		errorDiv.textContent = msg;
		errorDiv.classList.add('visible');
	}

	function clearError() {
		errorDiv.classList.remove('visible');
	}

	function renderDiagram(xml) {
		viewerContainer.innerHTML = '';

		const container = document.createElement('div');
		container.className = 'mxgraph';
		container.style.maxWidth = '100%';
		container.setAttribute('data-mxgraph', JSON.stringify({
			highlight: '#0000ff',
			lightbox: false,
			nav: true,
			resize: true,
			toolbar: 'zoom',
			xml: xml
		}));

		viewerContainer.appendChild(container);

		if (typeof GraphViewer !== 'undefined') {
			GraphViewer.processElements();
		}
	}

	function doConvert() {
		clearError();
		const text = editor.value.trim();
		if (text === '') {
			showError('Enter some PlantUML text');
			return;
		}

		try {
			const result = convert(text);
			diagramTypeSpan.textContent = 'Type: ' + result.diagramType;
			renderDiagram(result.xml);
		} catch (err) {
			showError(err.message);
			diagramTypeSpan.textContent = '';
		}
	}

	convertBtn.addEventListener('click', doConvert);

	editor.addEventListener('keydown', function(e) {
		// Ctrl+Enter or Cmd+Enter to convert
		if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
			e.preventDefault();
			doConvert();
		}
		// Tab inserts a tab character
		if (e.key === 'Tab') {
			e.preventDefault();
			const start = this.selectionStart;
			const end = this.selectionEnd;
			this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
			this.selectionStart = this.selectionEnd = start + 1;
		}
	});

	// Wait for the viewer script to load, then auto-convert
	function waitForViewer() {
		if (typeof GraphViewer !== 'undefined') {
			viewerReady = true;
			doConvert();
		} else {
			setTimeout(waitForViewer, 100);
		}
	}

	// Start polling â€” the viewer script loads async
	waitForViewer();
</script>

<!-- draw.io viewer (loads async, non-module) -->
<script src="https://viewer.diagrams.net/js/viewer-static.min.js" async></script>

</body>
</html>
